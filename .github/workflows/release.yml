name: ğŸš€ Create Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

# Grant the GITHUB_TOKEN permission to push commits and create releases
permissions:
  contents: write

jobs:
  release:
    name: Build & Publish XCFramework
    runs-on: macos-14  # Apple Silicon runner, 14 GB RAM

    # Memory profile on the 14GB macos-14 runner:
    #   Gradle JVM:           ~1 GB  (set via kotlin.native.jvmArgs in gradle.properties)
    #   Kotlin/Native compiler: 12 GB (set via kotlin.native.jvmArgs in gradle.properties)
    #   OS + misc:            ~1 GB
    #   Total:               ~14 GB  âœ”ï¸
    # No GRADLE_OPTS override needed â€“ gradle.properties already tuned for CI.

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout full history so we can verify branch
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history needed for branch check
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Guard: only allow tags that originate from main
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸŒ¿ Verify tag is on main branch
        run: |
          TAG_COMMIT=$(git rev-list -n 1 "${{ github.ref_name }}")
          if ! git merge-base --is-ancestor "$TAG_COMMIT" origin/main; then
            echo "âŒ Tag ${{ github.ref_name }} was not created from main branch."
            exit 1
          fi
          echo "âœ… Tag ${{ github.ref_name }} is on main branch."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Extract version numbers from the tag (e.g. v1.0.2 â†’ 1.0.2)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”– Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "tag=$TAG"         >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ·ï¸  Tag: $TAG  |  Version: $VERSION"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Java 17 (required by Gradle/KMP)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Gradle cache
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ğŸ”‘ Make gradlew executable
        run: chmod +x gradlew

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Build the RELEASE XCFramework
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Build XCFramework (Release)
        run: |
          echo "ğŸ”¨ Building DadoMatchShared XCFramework â€“ Release build..."
          echo "ğŸ§  Available memory before build:"
          vm_stat | grep 'Pages free\|Pages active\|Pages wired' || true

          # --no-daemon     : fresh JVM each run, no daemon competing for RAM
          # --max-workers 1 : ONE Kotlin/Native compiler at a time (12g each)
          #                   running 2 in parallel = 24g > 14g runner = OOM
          ./gradlew shared:assembleDadoMatchSharedReleaseXCFramework \
            --no-daemon \
            --max-workers 1
          echo "âœ… Gradle build finished."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Zip the XCFramework
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Package XCFramework into zip
        run: |
          XCFRAMEWORK_PATH="shared/build/XCFrameworks/release/DadoMatchShared.xcframework"

          if [ ! -d "$XCFRAMEWORK_PATH" ]; then
            echo "âŒ XCFramework not found at: $XCFRAMEWORK_PATH"
            exit 1
          fi

          cd shared/build/XCFrameworks/release
          zip -r DadoMatchShared.xcframework.zip DadoMatchShared.xcframework
          mv DadoMatchShared.xcframework.zip ../../../../
          cd ../../../../

          echo "âœ… DadoMatchShared.xcframework.zip created."
          ls -lh DadoMatchShared.xcframework.zip

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Compute Swift Package Manager checksum
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Calculate checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum DadoMatchShared.xcframework.zip)
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"
          echo "ğŸ“‹ SHA256 checksum: $CHECKSUM"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Create GitHub Release and upload the zip
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ‰ Create GitHub Release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"
          REPO="${{ github.repository }}"
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          gh release create "$TAG" "DadoMatchShared.xcframework.zip" \
            --repo "$REPO" \
            --title "DadoMatchShared $TAG" \
            --notes "# DadoMatchShared $TAG

          ğŸš€ **New Release of DadoMatchShared Framework**

          ## ğŸ“¦ What's Included
          - Optimized XCFramework for iOS (**release build**)
          - Compatible with iOS 16.0+
          - Ready for Swift Package Manager integration

          ## ğŸ“‹ Technical Details
          | Field | Value |
          |---|---|
          | **File** | \`DadoMatchShared.xcframework.zip\` |
          | **SHA256** | \`$CHECKSUM\` |
          | **Built** | $BUILD_DATE |

          ## ğŸ”§ Swift Package Manager Integration

          ### Option 1 â€“ \`Package.swift\`
          \`\`\`swift
          dependencies: [
              .package(url: \"https://github.com/$REPO\", from: \"$VERSION\")
          ]
          \`\`\`

          ### Option 2 â€“ Xcode
          1. **File â†’ Add Package Dependencies**
          2. Enter: \`https://github.com/$REPO\`
          3. Select version **$VERSION** or *Up to Next Major*

          ---
          *Built automatically by GitHub Actions on $BUILD_DATE*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Update Package.swift with real download URL + checksum
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Update Package.swift
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"
          REPO="${{ github.repository }}"
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/$TAG/DadoMatchShared.xcframework.zip"

          cat > Package.swift << SWIFT
          // swift-tools-version: 5.9
          // Auto-generated by GitHub Actions release workflow â€“ do not edit manually.
          import PackageDescription

          let package = Package(
              name: "DadoMatchShared",
              platforms: [
                  .iOS(.v16)
              ],
              products: [
                  .library(
                      name: "DadoMatchShared",
                      targets: ["DadoMatchSharedWrapper"]
                  ),
              ],
              dependencies: [
                  .package(url: "https://github.com/RevenueCat/purchases-hybrid-common.git", exact: "17.32.0"),
              ],
              targets: [
                  .binaryTarget(
                      name: "DadoMatchSharedBinary",
                      url: "$DOWNLOAD_URL",
                      checksum: "$CHECKSUM"
                  ),
                  .target(
                      name: "DadoMatchSharedWrapper",
                      dependencies: [
                          "DadoMatchSharedBinary",
                          .product(name: "PurchasesHybridCommon", package: "purchases-hybrid-common"),
                          .product(name: "PurchasesHybridCommonUI", package: "purchases-hybrid-common"),
                      ]
                  )
              ]
          )
          SWIFT

          echo "âœ… Package.swift updated"
          echo "   URL:      $DOWNLOAD_URL"
          echo "   Checksum: $CHECKSUM"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Update VERSION tracking file
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“„ Update VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > VERSION
          echo "âœ… VERSION â†’ ${{ steps.version.outputs.version }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 12. Commit updated Package.swift + VERSION back to main
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”„ Commit and push release changes to main
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Package.swift VERSION

          if git diff --cached --quiet; then
            echo "â„¹ï¸  No changes to commit."
          else
            git commit -m "chore: release ${{ steps.version.outputs.version }} [skip ci]

          - Update Package.swift with release download URL
          - Update Package.swift checksum: ${{ steps.checksum.outputs.checksum }}
          - Update VERSION to ${{ steps.version.outputs.version }}"

            git push origin HEAD:main
            echo "âœ… Changes pushed to main."
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 13. Print summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸŠ Release Summary
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ‰  RELEASE CREATED SUCCESSFULLY          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ·ï¸  Tag:         $TAG"
          echo "  ğŸ“¦  Asset:       DadoMatchShared.xcframework.zip"
          echo "  ğŸ”  Checksum:    ${{ steps.checksum.outputs.checksum }}"
          echo "  ğŸ”—  Release URL: https://github.com/$REPO/releases/tag/$TAG"
          echo ""
